<script>
  // Your specific Lambda URL
  const API_URL =
    "https://aqgk7uhomrvx7kk5qcj3qqlfia0tpxff.lambda-url.us-east-1.on.aws/";

  let table = null;

  async function fetchData() {
    const location = document.getElementById("location").value;
    const radius = document.getElementById("radius").value;

    if (!location) return alert("Please enter a location");

    document.getElementById("loading").style.display = "block";

    // Reset table if it exists
    if (table) {
      table.clear().draw();
      table.destroy();
    }

    try {
      const url = `${API_URL}?location=${encodeURIComponent(
        location
      )}&radius=${encodeURIComponent(radius)}`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.error) {
        alert("Error: " + data.error);
        return;
      }

      table = $("#resultsTable").DataTable({
        data: data.businesses,
        // 'B' = Buttons, 'l' = Length (dropdown), 'f' = Filter, 'r' = Processing, 't' = Table, 'i' = Info, 'p' = Pagination
        dom: "Blfrtip",
        buttons: [
          {
            extend: "excelHtml5",
            text: "Download Excel",
            className: "btn btn-success btn-sm",
            title: `Food_Businesses_${location}`,
          },
          {
            extend: "csvHtml5",
            text: "Download CSV",
            className: "btn btn-secondary btn-sm",
            title: `Food_Businesses_${location}`,
          },
        ],
        columns: [
          { data: "name", defaultContent: "<i>Unnamed</i>" },
          {
            data: "type",
            render: function (data) {
              return data
                ? data.charAt(0).toUpperCase() + data.slice(1).replace("_", " ")
                : "N/A";
            },
          },
          { data: "cuisine", defaultContent: "-" },
          {
            data: null,
            render: function (data, type, row) {
              let addr = row.address !== "N/A" ? row.address : "";
              let city = row.city !== "N/A" ? row.city : "";
              return [addr, city].filter(Boolean).join(", ") || "N/A";
            },
          },
          {
            data: null,
            render: function (data, type, row) {
              return `<a href="https://www.google.com/maps/search/?api=1&query=${row.lat},${row.lon}" target="_blank" class="btn btn-outline-primary btn-sm">View Map</a>`;
            },
          },
        ],
        order: [[0, "asc"]],
        pageLength: 25,
      });
    } catch (error) {
      console.error(error);
      alert("Failed to fetch data. Check console for details.");
    } finally {
      document.getElementById("loading").style.display = "none";
    }
  }

  // Initialize empty table on load
  $(document).ready(function () {
    table = $("#resultsTable").DataTable({ dom: "Blfrtip", buttons: [] });
  });
</script>
