<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Business Finder</title>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
        font-family: sans-serif;
      }
      .container {
        max-width: 1200px;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      #loading {
        display: none;
      }
      .dt-buttons .btn {
        margin-right: 5px;
        margin-bottom: 15px;
      }
      /* Fix alignment of the length dropdown */
      .dataTables_length {
        margin-bottom: 15px;
        margin-right: 15px;
        display: inline-block;
      }
      .dt-buttons {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h2 class="mb-4">üìç Food Business Finder</h2>

      <div class="row g-3 align-items-end mb-4">
        <div class="col-md-5">
          <label for="location" class="form-label">Location</label>
          <input
            type="text"
            class="form-control"
            id="location"
            placeholder="e.g. Cork City"
            value="Cork City"
          />
        </div>
        <div class="col-md-3">
          <label for="radius" class="form-label">Radius (meters)</label>
          <input type="number" class="form-control" id="radius" value="1000" />
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="fetchData()">
            Search
          </button>
        </div>
      </div>

      <div id="loading" class="text-center my-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Scanning area...</p>
      </div>

      <div class="table-responsive">
        <table
          id="resultsTable"
          class="table table-striped table-hover"
          style="width: 100%"
        >
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Cuisine</th>
              <th>Address</th>
              <th>Map</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>

    <script>
      const API_URL =
        "https://aqgk7uhomrvx7kk5qcj3qqlfia0tpxff.lambda-url.us-east-1.on.aws/";
      let table = null;

      async function fetchData() {
        const location = document.getElementById("location").value;
        const radius = document.getElementById("radius").value;

        if (!location) return alert("Please enter a location");

        document.getElementById("loading").style.display = "block";

        if (table) {
          table.clear().draw();
          table.destroy();
        }

        try {
          const url = `${API_URL}?location=${encodeURIComponent(
            location
          )}&radius=${encodeURIComponent(radius)}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.error) {
            alert("Error: " + data.error);
            return;
          }

          table = $("#resultsTable").DataTable({
            data: data.businesses,
            // 'B' = Buttons, 'l' = Length menu, 'f' = Filter, 'r' = pRocessing, 't' = Table, 'i' = Info, 'p' = Pagination
            dom: '<"d-flex justify-content-between"Blf>rtip',
            buttons: [
              {
                extend: "excelHtml5",
                text: "Download Excel",
                className: "btn btn-success btn-sm",
                title: `Food_Businesses_${location}`,
              },
              {
                extend: "csvHtml5",
                text: "Download CSV",
                className: "btn btn-secondary btn-sm",
                title: `Food_Businesses_${location}`,
              },
            ],
            lengthMenu: [
              [10, 25, 50, -1],
              [10, 25, 50, "All"],
            ],
            columns: [
              { data: "name", defaultContent: "<i>Unnamed</i>" },
              {
                data: "type",
                render: function (data) {
                  return data
                    ? data.charAt(0).toUpperCase() +
                        data.slice(1).replace("_", " ")
                    : "N/A";
                },
              },
              { data: "cuisine", defaultContent: "-" },
              {
                data: null,
                render: function (data, type, row) {
                  let addr = row.address !== "N/A" ? row.address : "";
                  let city = row.city !== "N/A" ? row.city : "";
                  return [addr, city].filter(Boolean).join(", ") || "N/A";
                },
              },
              {
                data: null,
                render: function (data, type, row) {
                  return `<a href="http://googleusercontent.com/maps.google.com/?q=${row.lat},${row.lon}" target="_blank" class="btn btn-outline-primary btn-sm">View Map</a>`;
                },
              },
            ],
            order: [[0, "asc"]],
            pageLength: 25,
          });
        } catch (error) {
          console.error(error);
          alert("Failed to fetch data. Check console for details.");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      $(document).ready(function () {
        // Initialize empty with the same DOM structure so buttons appear on load
        table = $("#resultsTable").DataTable({
          dom: '<"d-flex justify-content-between"Blf>rtip',
          buttons: [],
          lengthMenu: [
            [10, 25, 50, -1],
            [10, 25, 50, "All"],
          ],
        });
      });
    </script>
  </body>
</html>
