<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Business Finder</title>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      #loading {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h2 class="mb-4">üìç Food Business Finder</h2>

      <div class="row g-3 align-items-end mb-4">
        <div class="col-md-5">
          <label for="location" class="form-label">Location</label>
          <input
            type="text"
            class="form-control"
            id="location"
            placeholder="e.g. Cork City"
            value="Cork City"
          />
        </div>
        <div class="col-md-3">
          <label for="radius" class="form-label">Radius (meters)</label>
          <input type="number" class="form-control" id="radius" value="1000" />
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="fetchData()">
            Search
          </button>
        </div>
      </div>

      <div id="loading" class="text-center my-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Scanning area...</p>
      </div>

      <div class="table-responsive">
        <table
          id="resultsTable"
          class="table table-striped table-hover"
          style="width: 100%"
        >
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Cuisine</th>
              <th>Address</th>
              <th>Distance</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
      // Your specific Lambda URL
      const API_URL =
        "https://aqgk7uhomrvx7kk5qcj3qqlfia0tpxff.lambda-url.us-east-1.on.aws/";

      let table = null;

      async function fetchData() {
        // 1. Get inputs
        const location = document.getElementById("location").value;
        const radius = document.getElementById("radius").value;

        if (!location) return alert("Please enter a location");

        // 2. UI Updates
        document.getElementById("loading").style.display = "block";
        if (table) {
          table.clear().draw(); // Clear existing table data if it exists
        }

        try {
          // 3. Construct URL with query parameters
          const url = `${API_URL}?location=${encodeURIComponent(
            location
          )}&radius=${encodeURIComponent(radius)}`;

          // 4. Fetch Data
          const response = await fetch(url);
          const data = await response.json();

          // Check for API errors
          if (data.error) {
            alert("Error: " + data.error);
            return;
          }

          // 5. Populate DataTables
          // We use the DataTables API to add data so sorting works instantly
          if (table) {
            table.destroy(); // Reset table to load new data cleanly
          }

          table = $("#resultsTable").DataTable({
            data: data.businesses, // Pass the 'businesses' array directly
            columns: [
              { data: "name", defaultContent: "<i>Unnamed</i>" },
              {
                data: "type",
                render: function (data) {
                  // Capitalize first letter (e.g., "restaurant")
                  return data
                    ? data.charAt(0).toUpperCase() +
                        data.slice(1).replace("_", " ")
                    : "N/A";
                },
              },
              { data: "cuisine", defaultContent: "-" },
              {
                data: null, // Combine street and city for Address column
                render: function (data, type, row) {
                  let addr = row.address !== "N/A" ? row.address : "";
                  let city = row.city !== "N/A" ? row.city : "";
                  return [addr, city].filter(Boolean).join(", ") || "N/A";
                },
              },
              {
                // Hidden helper column for coordinates if you need them later
                data: null,
                render: function (data, type, row) {
                  return `<a href="https://www.google.com/maps/search/?api=1&query=${row.lat},${row.lon}" target="_blank">View Map</a>`;
                },
              },
            ],
            order: [[0, "asc"]], // Default sort by Name
            pageLength: 25, // Show 25 rows by default
          });
        } catch (error) {
          console.error(error);
          alert("Failed to fetch data. Check console for details.");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      // Initialize empty table on load
      $(document).ready(function () {
        table = $("#resultsTable").DataTable();
      });
    </script>
  </body>
</html>
